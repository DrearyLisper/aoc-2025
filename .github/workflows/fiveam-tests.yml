# .github/workflows/fiveam-tests.yml
name: Run FiveAM tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest


    steps:
      # ------------------------------------------------------------------
      # Checkout the repository
      # ------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------------
      # Install SBCL (apt package) and curl (for Quicklisp)
      # ------------------------------------------------------------------
      - name: Install SBCL & utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y sbcl curl make

      # ------------------------------------------------------------------
      # Install Quicklisp
      # ------------------------------------------------------------------
      - name: Install Quicklisp
        if: steps.restore-quicklisp-cache.outputs.cache-hit != 'true'
        env:
          QUICKLISP_DIST: ${{ runner.temp }}/quicklisp
          QUICKLISP_HOME: ${{ runner.temp }}/quicklisp
        run: |
          mkdir -p "${QUICKLISP_DIST}"
          curl -o /tmp/quicklisp.lisp https://beta.quicklisp.org/quicklisp.lisp
          sbcl --noinform --load /tmp/quicklisp.lisp \
               --eval '(quicklisp-quickstart:install :path "'"${QUICKLISP_DIST}"'")' \
               --eval '(load "aoc-2025.asd")' \
               --eval '(ql:quickload :aoc-2025/test)' \
               --eval '(handler-case (asdf:test-system :aoc-2025/test) (error (e) (uiop:quit 1)))' \
               --quit
